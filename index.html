<html>
    <head>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.js"></script>
        <script src="https://cdn.jsdelivr.net/vue/1.0.28/vue.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.js"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Trading Notes</title>
        <style>
            #app {
                display: flex;
                align-items: center;
                font-family: 'Roboto', sans-serif;
                font-size: 20px;
                flex-direction: column;
            }
            
            .term {
                width: 100%;
                margin:  10px;
            }

            .search-area {
                width:  100%;
                height: 60px;
                display: flex;
                align-items: center;
            }

            .text-search {
                width: 100%;
                height: 40px;
                font-size: 15pt;
            }

            .term-table {
                font-size: 15pt;
            }

            table {
                width: 100%;
            }

            table tr th {
                text-align: left;
            }

            table tr {
                height: 30px;
            }
        </style>
    </head>
    <body>
        <div id="app">
            <div class="term">
                <div class="search-area">
                    <input type="text" v-model="searchText" class="text-search">
                </div>
                <div v-for="term in filterTerms">
                    <h2>
                        {{term.title}}
                    </h2>
                    <p>
                        {{term.content}}
                    </p>
                </div>
            </div>
            <div class="term">
                <div class="search-area">
                    <input type="text" v-model="searchAticles" class="text-search">
                </div>
                <table>
                    <tr>
                        <th>Name</th>
                        <th @click="sortBy = 'replies'">Replies</th>
                        <th @click="sortBy = 'views'">Views</th>
                    </tr>
                    <tr v-for="article in filterArticles">
                        <td>
                            <a :href="article.url">{{ article.name }}</a>
                        </td>
                        <td>
                            {{ article.replies }}
                        </td>
                        <td>
                            {{ article.views }}
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        <script>
            var googleSpreadSheetId = "1nGnC3swMxl0n-nkkqHKxfnp4zDMlTAylVYvq5D8tRzA";
            var apiKey = "AIzaSyD3_rrZTCSgt5vbqdKm5wJY6bl_rSI2R3w";
            new Vue({
                el: '#app',
                data: {
                    terms: [],
                    articles: [],
                    searchText: '',
                    searchAticles: '',
                    fuseTerms: null,
                    fuseArticles: null,
                    sortBy: 'views'
                },
                computed: {
                    filterTerms: function () {
                        function randomInteger(min, max) {
                          return Math.floor(Math.random() * (max - min + 1)) + min;
                        }
                        var randomIndex = randomInteger(0, this.terms.length - 1);
                        return this.searchText != "" ? this.fuseTerms.search(this.searchText).map(item => item.item).slice(0, 3) : [this.terms[randomIndex]];
                    },
                    filterArticles: function () {
                        var vm = this;
                        function sortViews(a, b) {
                            if ( a[vm.sortBy] < b[vm.sortBy] ){
                                return 1;
                              }
                              if ( a[vm.sortBy] > b[vm.sortBy] ){
                                return -1;
                              }
                              return 0;
                        }
                        return (this.searchAticles != "" ? this.fuseArticles.search(this.searchAticles).map(item => item.item).slice(0, 10) : this.articles).sort(sortViews);
                    },
                },
                created() {
                    var vm = this;
                    var url = "https://sheets.googleapis.com/v4/spreadsheets/" + googleSpreadSheetId + "/values/Terms!A:B?alt=json&key=" + apiKey;
                    axios.get(url).then(response => {
                        vm.terms = response.data.values.map(item => {
                            return {
                                "title": item[0],
                                "content": item[1]
                            }
                        });
                        vm.terms.shift();
                        vm.fuseTerms = new Fuse(vm.terms, {
                            includeScore: true,
                            keys: ['title', 'content']
                        });
                    })

                    axios.get('https://raw.githubusercontent.com/hzung/hzung.github.io/main/Al-Trade-Setups.json').then(response => {
                        vm.articles = response.data;
                        vm.fuseArticles = new Fuse(vm.articles, {
                            includeScore: true,
                            keys: ['name']
                        });
                    })
                }
            })
        </script>
    </body>
</html>